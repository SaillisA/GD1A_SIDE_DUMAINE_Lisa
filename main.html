<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" /><title>Mon 1er jeu Phaser</title>
<script
src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
<style type="text/css"> body { margin: 0; }</style>
</head>
<body>
<script type="text/javascript">
    var config = {
        type: Phaser.AUTO,
        width: 800,
        physics: {
            default: 'arcade',
            arcade: {
            gravity: { y: 300 },
            debug: true
        }},
        height: 600,
        scene: {preload: preload, create: create, update: update }
    };
    new Phaser.Game(config);

    function preload(){
        this.load.spritesheet('perso','assets/perso.png',
        { frameWidth: 32, frameHeight: 32 });

        this.load.image("Phaser_tuilesdejeu","assets/tileset_pour_de_vrai.png");
        this.load.tilemapTiledJSON("carte","assets/premier_niveau.json");
    }
    var platforms;
    var player;

    function create(){
        // chargement de la carte
        const carteDuNiveau = this.add.tilemap("carte");

        // chargement du jeu de tuiles
        const tileset = carteDuNiveau.addTilesetImage(
          "tileset_pour_de_vrai",
          "Phaser_tuilesdejeu"
        );  

        //les caaaaalques (oskour)

        const calque_terre = carteDuNiveau.createLayer(
          "terre",
          tileset
        );
        const calque_fond = carteDuNiveau.createLayer(
          "fond",
          tileset
        );
        const calque_bordsFenetre = carteDuNiveau.createLayer(
          "bordsFenetre",
          tileset
        );
        const calque_fumeRouge = carteDuNiveau.createLayer(
          "fumeRouge",
          tileset
        );
        const calque_piques = carteDuNiveau.createLayer(
          "piques",
          tileset
        );

        const calque_plateformes = carteDuNiveau.createLayer(
          "murSol",
          tileset
        );

        const calque_base = carteDuNiveau.createLayer(
          "base",
          tileset
        );
        const calque_effet = carteDuNiveau.createLayer(
          "effet",
          tileset
        );
        // définition des tuiles de plateformes qui sont solides
        // utilisation de la propriété estSolide
        calque_plateformes.setCollisionByProperty({ estSolide: true }); 

        calque_piques.setCollisionByProperty({ estPiques: true});
        

        //joueur :
        player = this.physics.add.sprite(50, 1520, 'perso');
        player.setBounce(0.2);
        player.setCollideWorldBounds(true);
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
            frameRate: 10,
            repeat: -1
        });
            this.anims.create({
            key: 'turn',
            frames: [ { key: 'perso', frame: 4 } ],
            frameRate: 20
        });
        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
            frameRate: 10,
            repeat: -1
        });
        cursors = this.input.keyboard.createCursorKeys();
        
        const calque_lave = carteDuNiveau.createLayer(
          "lave",
          tileset
        );
          
        const calque_premierPlan = carteDuNiveau.createLayer(
          "premPlan",
          tileset
        );

        calque_lave.setCollisionByProperty({ estLave: true});

        //collision jouer et calques plateformes
        this.physics.add.collider(player, calque_plateformes); 

        this.physics.add.collider(player, calque_piques, death,null,this)

        this.physics.add.collider(player, calque_lave, death,null,this)
        

        // redimentionnement du monde avec les dimensions calculées via tiled
        this.physics.world.setBounds(0, 0, 1600, 1600);
        //  ajout du champs de la caméra de taille identique à celle du monde
        this.cameras.main.setBounds(0, 0, 1600, 1600);
        // ancrage de la caméra sur le joueur
        this.cameras.main.startFollow(player);
        this.cameras.main.setZoom(3);

    }
   

    function update(){
      if (cursors.left.isDown){ //si la touche gauche est appuyée
          player.setVelocityX(-160); //alors vitesse négative en X
          player.anims.play('left', true); //et animation => gauche
      }
      else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
          player.setVelocityX(160); //alors vitesse positive en X
          player.anims.play('right', true); //et animation => droite
      }
      else{ // sinon
          player.setVelocityX(0); //vitesse nulle
          player.anims.play('turn'); //animation fait face caméra
      }
      if (cursors.up.isDown && player.body.blocked.down) {
          //si touche haut appuyée ET que le perso touche le sol
          player.setVelocityY(-200); //alors vitesse verticale négative
          //(on saute)
      }
      if(cursors.up.isDown && player.body.blocked.right){
        player.setVelocityY(-200);
      }
      if(cursors.up.isDown && player.body.blocked.left){
        player.setVelocityY(-200);
      }


      if(cursors.down.isDown){
        //TP lvl 1 Bleu aller/retour
        if((player.body.x >178 && player.body.x <207) && player.body.y == 1536){
          player.body.position.x = 1471
          player.body.position.y = 1484
          console.log("BLEUAller")
        }
        else if((player.body.x >1461 && player.body.x <1485)&&  player.body.y == 1504){
          player.body.position.x = 190
          player.body.position.y = 1516
          console.log("BLEUretour")
        }


        //TP petit violet aller/retour
        else if(player.body.x ==1024 && player.body.y == 1408){
          player.body.position.x = 62
          player.body.position.y = 76
          console.log("violetaller")
        }
        else if((player.body.x >50 && player.body.x < 74) && player.body.y == 96 ){
          player.body.position.x = 1024
          player.body.position.y = 1388
          console.log("violetretour")
        }

        //TP bleu ciel aller/retour
        else if((player.body.x >885 && player.body.x <909) && player.body.y == 1056){
          player.body.position.x = 1374
          player.body.position.y = 1356
          console.log("bleuciel")
        }
        else if((player.body.x >1362 && player.body.x <1389) && player.body.y == 1376){
          player.body.position.x = 896
          player.body.position.y = 1036
          console.log("bleuretour")
        }

        //TP bleu foncer aller/retour
        else if((player.body.x >117 && player.body.x <138) && player.body.y == 448){
          player.body.position.x = 1280
          player.body.position.y = 76
          console.log("bleuciel")
        }
        else if((player.body.x >1269 && player.body.x <1290) && player.body.y == 95.99999999999999 ){
          player.body.position.x = 128
          player.body.position.y = 428
          console.log("bleuretour")
        }

        //TP bleu rose aller/retour
        else if((player.body.x >53 && player.body.x <75) && player.body.y == 448){
          player.body.position.x = 416
          player.body.position.y = 674
          console.log("bleuciel")
        }
        else if((player.body.x >406 && player.body.x <427) && player.body.y == 704){
          player.body.position.x = 63
          player.body.position.y = 428
          console.log("bleuretour")
        }

        //TP vert aller/retour
        else if((player.body.x >273 && player.body.x <303) && player.body.y == 1536 ){
          player.body.position.x = 96
          player.body.position.y = 1324
          console.log("VERTaller")
        }
        else if((player.body.x >83 && player.body.x <107) && player.body.y == 1344 ){
          player.body.position.x = 288
          player.body.position.y = 1516
          console.log("VERTretour")
        }

         //TP rouge aller/retour
        else if((player.body.x >372 && player.body.x <393) && player.body.y == 1536 ){
          player.body.position.x = 1007
          player.body.position.y = 488
          console.log("VERTaller")
        }
        else if((player.body.x >997 && player.body.x <1018) && player.body.y == 544 ){
          player.body.position.x = 383
          player.body.position.y = 1516
          console.log("VERTretour")
        }
         //TP violet aller/retour
         else if((player.body.x >628 && player.body.x <681) && player.body.y == 1504 ){
          player.body.position.x = 687
          player.body.position.y = 107
          console.log("VERTaller")
        }
        else if((player.body.x >673 && player.body.x <702) && player.body.y == 127.99999999999999 ){
          player.body.position.x = 654
          player.body.position.y = 1484
          console.log("VERTretour")
        }
      
      }
      
    }
    function death(){
        this.physics.pause();
        player.setTint(0xff0000);
        player.anims.play('turn');
      }
</script>
</body>
</html>
