<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" /><title>Mon 1er jeu Phaser</title>
<script
src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
<style type="text/css"> body { margin: 0; }</style>
</head>
<body>
<script type="text/javascript">
    var config = {
        type: Phaser.AUTO,
        width: 800,
        physics: {
            default: 'arcade',
            arcade: {
            gravity: { y: 300 },
            debug: true
        }},
        height: 600,
        scene: {preload: preload, create: create, update: update }
    };
    new Phaser.Game(config);

    function preload(){
        this.load.spritesheet('perso','assets/perso.png',
        { frameWidth: 22, frameHeight: 32 });

        this.load.image("Phaser_tuilesdejeu","assets/tileset_pour_de_vrai.png");
        this.load.tilemapTiledJSON("carte","assets/premier_niveau.json");

        this.load.image("cleTexture","assets/cle.png");
        this.load.image("potionTexture","assets/potion.png");
        this.load.image("gateTexture","assets/gate.png");
        this.load.image("pompeTexture","assets/pompe.png");
    }
    var platforms;
    var player;
    var nbrClecle = 0;
    var nbrPompom = 0;
    
    function create(){
        // chargement de la carte
        const carteDuNiveau = this.add.tilemap("carte");

        // chargement du jeu de tuiles
        const tileset = carteDuNiveau.addTilesetImage(
          "tileset_pour_de_vrai",
          "Phaser_tuilesdejeu"
        );  

        //les caaaaalques (oskour)

        const calque_terre = carteDuNiveau.createLayer(
          "terre",
          tileset
        );
        const calque_fond = carteDuNiveau.createLayer(
          "fond",
          tileset
        );
        const calque_bordsFenetre = carteDuNiveau.createLayer(
          "bordsFenetre",
          tileset
        );
        const calque_fumeRouge = carteDuNiveau.createLayer(
          "fumeRouge",
          tileset
        );
        const calque_piques = carteDuNiveau.createLayer(
          "piques",
          tileset
        );

        const calque_plateformes = carteDuNiveau.createLayer(
          "murSol",
          tileset
        );

        const calque_base = carteDuNiveau.createLayer(
          "base",
          tileset
        );
        const calque_effet = carteDuNiveau.createLayer(
          "effet",
          tileset
        );
        // définition des tuiles de plateformes qui sont solides
        // utilisation de la propriété estSolide
        calque_plateformes.setCollisionByProperty({ estSolide: true }); 

        calque_piques.setCollisionByProperty({ estSolide: true});
        

        //joueur :
        player = this.physics.add.sprite(50, 1520, 'perso');
        //player.setBounce(0.2);
        player.setCollideWorldBounds(true);
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
            frameRate: 10,
            repeat: -1
        });
            this.anims.create({
            key: 'turn',
            frames: [ { key: 'perso', frame: 4 } ],
            frameRate: 20
        });
        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
            frameRate: 10,
            repeat: -1
        });
        cursors = this.input.keyboard.createCursorKeys();
        
        const calque_lave = carteDuNiveau.createLayer(
          "lave",
          tileset
        );
          
        const calque_premierPlan = carteDuNiveau.createLayer(
          "premPlan",
          tileset
        );

        //creation des cles :
        clecle = this.physics.add.group({
          immovable : true ,
          allowGravity : false
        });
        calque_cle = carteDuNiveau.getObjectLayer("cle");
        calque_cle.objects.forEach(calque_cle => {
          const inutile = clecle.create(calque_cle.x + 16,calque_cle.y + 16,"cleTexture");
        });

        this.physics.add.overlap(player,clecle,collectClecle,null,this);

        //creation des potions :
        popo = this.physics.add.group({
          immovable : true ,
          allowGravity : false
        });

        calque_potion = carteDuNiveau.getObjectLayer("potion");
        calque_potion.objects.forEach(calque_potion => {
          const tjInutile = popo.create(calque_potion.x + 16,calque_potion.y + 16,"potionTexture");
        });
        this.physics.add.overlap(player,popo,collectPopo,null,this);
        
        //creation de la gate :
        gaga = this.physics.add.group({
          immovable : true,
          allowGravity : false
        });

        calque_gate = carteDuNiveau.getObjectLayer("gate");
        calque_gate.objects.forEach(calque_gate =>{
          const encoreInutile = gaga.create(calque_gate.x + 16, calque_gate.y +16, "gateTexture");
        });
        this.physics.add.collider(player,gaga,openGate,null,this);

        //creation des pompes :
        pompom = this.physics.add.group({
          immovable : true,
          allowGravity : false
        })

        calque_pompe = carteDuNiveau.getObjectLayer("pompe");
        calque_pompe.objects.forEach(calque_pompe =>{
          const encoreTjInutile = pompom.create(calque_pompe.x +16,calque_pompe.y + 16, "pompeTexture");
        });
        this.physics.add.collider(player,pompom,actionnerPompe,null,this);




        calque_lave.setCollisionByProperty({ estLave: true});

        //collision jouer et calques plateformes
        this.physics.add.collider(player, calque_plateformes); 

        this.physics.add.collider(player, calque_piques, death,null,this);

        this.physics.add.collider(player, calque_lave, death,null,this);


        //scoreText=this.add.text(player.body.x,player.body.y,'score: 0',{fontSize:'32px',fill:'#000'}).setScrollFactor(0);

        

        // redimentionnement du monde avec les dimensions calculées via tiled
        this.physics.world.setBounds(0, 0, 1600, 1600);
        //  ajout du champs de la caméra de taille identique à celle du monde
        this.cameras.main.setBounds(0, 0, 1600, 1600);
        // ancrage de la caméra sur le joueur
        this.cameras.main.startFollow(player);
        this.cameras.main.setZoom(3);

    }
   

    function update(){
      if (cursors.left.isDown){ //si la touche gauche est appuyée
          player.setVelocityX(-160); //alors vitesse négative en X
          player.anims.play('left', true); //et animation => gauche
      }
      else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
          player.setVelocityX(160); //alors vitesse positive en X
          player.anims.play('right', true); //et animation => droite
      }
      else{ // sinon
          player.setVelocityX(0); //vitesse nulle
          player.anims.play('turn'); //animation fait face caméra
      }
      if (cursors.up.isDown && player.body.blocked.down) {
          //si touche haut appuyée ET que le perso touche le sol
          player.setVelocityY(-200); //alors vitesse verticale négative
          //(on saute)
      }
      if(cursors.up.isDown && player.body.blocked.right){
        player.setVelocityY(-200);
      }
      if(cursors.up.isDown && player.body.blocked.left){
        player.setVelocityY(-200);
      }


      if(cursors.down.isDown){

        //pour accéder à la fin du niveau (portail final)
        //if((player.body.x > 532 && player.body.x < 554)&& player.body.y == 1536){}

        //TP lvl 1 Bleu aller/retour
        if((player.body.x >178 && player.body.x <207) && player.body.y == 1536){
          player.body.position.x = 1476
          player.body.position.y = 1484
          console.log("BLEUAller")
        }
        else if((player.body.x >1461 && player.body.x <1485)&&  player.body.y == 1504){
          player.body.position.x = 196
          player.body.position.y = 1516
          console.log("BLEUretour")
        }


        //TP petit violet aller/retour
        else if((player.body.x >= 1024 && player.body.x < 1037) && player.body.y == 1408){
          player.body.position.x = 70
          player.body.position.y = 76
          console.log("violetaller")
        }
        else if((player.body.x >50 && player.body.x < 74) && player.body.y == 96 ){
          player.body.position.x = 1029
          player.body.position.y = 1388
          console.log("violetretour")
        }

        //TP bleu ciel aller/retour
        else if((player.body.x >885 && player.body.x <909) && player.body.y == 1056){
          player.body.position.x = 1381
          player.body.position.y = 1356
          console.log("bleuciel")
        }
        else if((player.body.x >1362 && player.body.x <1389) && player.body.y == 1376){
          player.body.position.x = 901
          player.body.position.y = 1036
          console.log("bleuretour")
        }

        //TP bleu foncer aller/retour
        else if((player.body.x >117 && player.body.x <138) && player.body.y == 448){
          player.body.position.x = 1285
          player.body.position.y = 76
          console.log("bleuciel")
        }
        else if((player.body.x >1269 && player.body.x <1290) && player.body.y == 96 ){
          player.body.position.x = 134
          player.body.position.y = 428
          console.log("bleuretour")
        }

        //TP bleu rose aller/retour
        else if((player.body.x >53 && player.body.x <75) && player.body.y == 448){
          player.body.position.x = 421
          player.body.position.y = 674
          console.log("bleuciel")
        }
        else if((player.body.x >406 && player.body.x <427) && player.body.y == 704){
          player.body.position.x = 70
          player.body.position.y = 428
          console.log("bleuretour")
        }

        //TP vert aller/retour
        else if((player.body.x >273 && player.body.x <303) && player.body.y == 1536 ){
          player.body.position.x = 101
          player.body.position.y = 1324
          console.log("VERTaller")
        }
        else if((player.body.x >83 && player.body.x <107) && player.body.y == 1344 ){
          player.body.position.x = 292
          player.body.position.y = 1516
          console.log("VERTretour")
        }

         //TP rouge aller/retour
        else if((player.body.x >372 && player.body.x <393) && player.body.y == 1536 ){
          player.body.position.x = 1012
          player.body.position.y = 522
          console.log("VERTaller")
        }
        else if((player.body.x >997 && player.body.x <1018) && player.body.y == 544 ){
          player.body.position.x = 389
          player.body.position.y = 1516
          console.log("VERTretour")
        }

         //TP violet aller/retour
         else if((player.body.x >628 && player.body.x <681) && player.body.y == 1504 ){
          player.body.position.x = 692
          player.body.position.y = 107
          console.log("VERTaller")
        }
        else if((player.body.x >673 && player.body.x <710) && player.body.y == 128 ){
          player.body.position.x = 654
          player.body.position.y = 1484
          console.log("VERTretour")
        }
      
      }
      
    }
    function death(){
        this.physics.pause();
        player.setTint(0xff0000);
        player.anims.play('turn');
    }

    function collectClecle(player,clecle){
      clecle.disableBody(true,true);
      nbrClecle += 1;
    }

    function collectPopo(player,popo){
      popo.disableBody(true,true);
    };
    function openGate(player,gaga){
      if(nbrClecle == 3){
            console.log("portail ouvert")
            gaga.disableBody(true,true);
          }
    };
    function actionnerPompe(player,pompom){
      if(nbr < 3){
        nbrPompom +=1;
      };
      if(nbrPompom == 1){
        fume1;
        console.log("fumée 1 désactivé");
      };
      if(nbrPompom == 2){
        fume2;
        console.log("fumée 2 désactivé");
      };
      if(nbrPompom == 3){
        fume3;
        console.log("fumée 3 désactivé");
      };
    };
    function fume1(){

    };
    function fume2(){

    };
    function fume3(){

    };
</script>
</body>
</html>
