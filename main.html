<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" /><title>Mon 1er jeu Phaser</title>
<script
src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
<style type="text/css"> body { margin: 0; }</style>
</head>
<body>
<script type="text/javascript">
    var config = {
        type: Phaser.AUTO,
        width: 800,
        physics: {
            default: 'arcade',
            arcade: {
            gravity: { y: 300 },
            debug: false
        }},
        height: 600,
        scene: {preload: preload, create: create, update: update }
    };
    new Phaser.Game(config);

    function preload(){
        this.load.spritesheet('perso','assets/perso.png',
        { frameWidth: 32, frameHeight: 48 });

        this.load.image("Phaser_tuilesdejeu","assets/tileset_pour_de_vrai.png");
        this.load.tilemapTiledJSON("carte","assets/premier_niveau.json");
    }
    var platforms;
    var player;

    function create(){
        // chargement de la carte
        const carteDuNiveau = this.add.tilemap("carte");

        // chargement du jeu de tuiles
        const tileset = carteDuNiveau.addTilesetImage(
          "tileset_pour_de_vrai",
          "Phaser_tuilesdejeu"
        );  

        //les caaaaalques (oskour)

        const calque_terre = carteDuNiveau.createLayer(
          "terre",
          tileset
        );
        const calque_fond = carteDuNiveau.createLayer(
          "fond",
          tileset
        );
        const calque_bordsFenetre = carteDuNiveau.createLayer(
          "bordsFenetre",
          tileset
        );
        const calque_fumeRouge = carteDuNiveau.createLayer(
          "fumeRouge",
          tileset
        );
        const calque_piques = carteDuNiveau.createLayer(
          "piques",
          tileset
        );

        const calque_plateformes = carteDuNiveau.createLayer(
          "murSol",
          tileset
        );

        // définition des tuiles de plateformes qui sont solides
        // utilisation de la propriété estSolide
        calque_plateformes.setCollisionByProperty({ estSolide: true }); 


        //joueur :
        player = this.physics.add.sprite(50, 1550, 'perso');
        player.setBounce(0.2);
        player.setCollideWorldBounds(true);
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
            frameRate: 10,
            repeat: -1
        });
            this.anims.create({
            key: 'turn',
            frames: [ { key: 'perso', frame: 4 } ],
            frameRate: 20
        });
        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
            frameRate: 10,
            repeat: -1
        });
        cursors = this.input.keyboard.createCursorKeys();
        
        const calque_teleporteBleu = carteDuNiveau.createLayer(
          "tpbleu",
          tileset
        );
        const calque_teleporteVert = carteDuNiveau.createLayer(
          "tpvert",
          tileset
        );
        const calque_teleporteRouge = carteDuNiveau.createLayer(
          "tprouge",
          tileset
        );
        const calque_teleporteBigViolet = carteDuNiveau.createLayer(
          "tpviolet",
          tileset
        );
        const calque_teleporteBleuFonce = carteDuNiveau.createLayer(
          "tpbf",
          tileset
        );
        const calque_teleporteBleuClair = carteDuNiveau.createLayer(
          "tpbc",
          tileset
        );
        const calque_teleporteRose = carteDuNiveau.createLayer(
          "tpr",
          tileset
        );
        const calque_teleporteViolet = carteDuNiveau.createLayer(
          "tpv",
          tileset
        );
        const calque_premierPlan = carteDuNiveau.createLayer(
          "premPlan",
          tileset
        );

        //collision jouer et calques plateformes
        this.physics.add.collider(player, calque_plateformes); 

        // redimentionnement du monde avec les dimensions calculées via tiled
        this.physics.world.setBounds(0, 0, 1600, 1600);
        //  ajout du champs de la caméra de taille identique à celle du monde
        this.cameras.main.setBounds(0, 0, 1600, 1600);
        // ancrage de la caméra sur le joueur
        this.cameras.main.startFollow(player);  

    }
    function update(){
      if (cursors.left.isDown){ //si la touche gauche est appuyée
          player.setVelocityX(-160); //alors vitesse négative en X
          player.anims.play('left', true); //et animation => gauche
      }
      else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
          player.setVelocityX(160); //alors vitesse positive en X
          player.anims.play('right', true); //et animation => droite
      }
      else{ // sinon
          player.setVelocityX(0); //vitesse nulle
          player.anims.play('turn'); //animation fait face caméra
      }
      if (cursors.up.isDown && player.body.blocked.down) {
          //si touche haut appuyée ET que le perso touche le sol
          player.setVelocityY(-200); //alors vitesse verticale négative
          //(on saute)
        } 
    }
</script>
</body>
</html>
